# Local File MCP Requirements (v1)

## 1. 背景与目标
你希望 Agent 能处理这类任务：
- “D 盘有一篇 paper.pdf，帮我读并总结，再保存到 Notion。”

这要求系统具备两种能力：
1. 具体指令执行（列目录、读文件、总结、保存）
2. 抽象任务自动规划（Agent 自主拆解步骤并调用工具）

本需求文档定义：
- MVP（先可用）
- 扩展优化（再智能）
- 面向未来扩展的接口约束

---

## 2. 范围定义

### 2.1 MVP In Scope
1. 新增本地文件 MCP 工具（最小集合）
   - `list_local_files`
   - `read_text_file`
   - `extract_pdf_text`
2. Agent 可根据用户请求调用上述工具
3. 支持把总结结果保存到 Notion（复用现有 `save_chat_answer`）
4. 支持“具体指令型”与“轻量抽象任务型”输入

### 2.2 Out of Scope (Phase 2+)
1. 全盘任意读写（高风险，不做）
2. 文件修改/删除/移动（MVP 不做写操作）
3. 复杂 OCR（扫描 PDF）
4. 多文件语义检索数据库（向量库）
5. 权限弹窗与系统级安全策略中心

---

## 3. 功能需求

### FR-1 根目录白名单机制
1. 系统只允许访问“配置允许的本地目录”，如：
   - `D:\papers`
   - `D:\notes`
2. 拒绝访问白名单外路径
3. 所有路径必须标准化后再判断（防目录穿越）

### FR-2 文件列表工具 `list_local_files`
1. 输入：
   - `path`（相对白名单或绝对路径）
   - `recursive`（可选，默认 false）
   - `max_entries`（可选，默认 100）
2. 输出：
   - 文件/目录名
   - 类型（file/dir）
   - 大小
   - 修改时间
3. 错误：
   - 路径不存在
   - 权限不足
   - 超出白名单

### FR-3 文本读取工具 `read_text_file`
1. 支持 txt/md/json/csv/code 等文本文件
2. 输入：
   - `path`
   - `max_chars`（默认例如 12000）
3. 输出：
   - 文本内容（截断时标记）
   - 编码信息（若可识别）

### FR-4 PDF 读取工具 `extract_pdf_text`
1. 输入：
   - `path`
   - `max_pages`（默认例如 30）
2. 输出：
   - 分页文本（可选前 N 页）
   - 总页数
   - 抽取状态（是否截断）
3. MVP 限制：
   - 优先支持“可复制文本 PDF”
   - 扫描版只返回“文本不足”提示

### FR-5 Agent 任务编排
1. 支持具体命令：
   - “列出 D:\papers 有哪些文件”
   - “打开 D:\papers\paper.pdf 并总结”
2. 支持抽象命令：
   - “把 D 盘那篇论文读完，总结并存 Notion”
3. 编排原则：
   - 先定位文件 -> 读取内容 -> 总结 -> 保存 -> 回执

### FR-6 Notion 保存回执
1. 保存成功后返回：
   - Notion 页面 URL
   - 标题
   - 摘要长度
2. 失败时返回明确原因

---

## 4. 非功能需求

### NFR-1 安全性
1. 强制白名单目录
2. 禁止可执行命令透传
3. 日志中不输出敏感全文（只输出长度与摘要）

### NFR-2 性能
1. 单次读取限制大小，避免阻塞
2. 大文件采用分页/分块
3. 设置工具调用超时

### NFR-3 可维护性
1. 工具粒度保持清晰（list/read/pdf 分离）
2. 统一返回结构：`text` + `data`
3. 便于后续新增 docx/xlsx/image OCR

### NFR-4 可观测性
1. 记录每次工具调用：
   - toolName
   - path
   - duration
   - resultSize
2. 错误码标准化

---

## 5. 配置需求

建议新增运行时配置：
1. `LOCAL_FILE_ALLOWED_ROOTS`（分号分隔）
2. `LOCAL_FILE_MAX_READ_CHARS`
3. `LOCAL_FILE_MAX_LIST_ENTRIES`
4. `LOCAL_FILE_MAX_PDF_PAGES`

---

## 6. 验收标准（MVP）
1. 能列出白名单目录文件
2. 能读取 txt/md 文件并返回内容
3. 能读取文本型 PDF 并生成摘要
4. 能将摘要写入 Notion 并返回页面链接
5. 非白名单路径访问被拒绝且有明确错误
6. TypeScript 检查与构建通过

---

## 7. 风险与缓解
1. PDF 抽取质量不稳定
   - 缓解：优先文本型 PDF，扫描版提示受限
2. 路径安全风险
   - 缓解：标准化 + 白名单 + 拒绝符号链接穿透（Phase 2）
3. 大文件导致响应慢
   - 缓解：分块读取 + 最大长度限制
4. Agent 误判任务步骤
   - 缓解：系统提示加入“文件任务优先流程”

---

## 8. 后续扩展方向（Phase 2+）
1. 文档类型扩展：docx/xlsx/pptx
2. OCR：图片/扫描版 PDF
3. 项目级知识索引（向量库）
4. 批处理任务（目录批量总结）
5. 权限策略 UI（每个目录可单独开关）
