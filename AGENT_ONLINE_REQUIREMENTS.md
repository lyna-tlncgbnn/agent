# Agent Online Capability Requirements (v2)

## 1. 背景
当前项目已具备：
1. 多会话聊天与流式输出（SSE）
2. 会话持久化（SQLite）
3. MCP 网关（已有 Notion + Weather 工具）

现状问题：
1. 联网能力仅覆盖天气，范围太窄
2. 工具调用由代码规则触发，不是模型自主决策
3. 扩展新闻/股价/实时事件时，需要不断堆 if-else

目标是把现有链路升级为“通用 Agent 工具调用架构”，并继续使用统一 MCP。

## 2. 总体目标
1. 从“规则路由”升级到“模型 Tool Calling 决策”
2. 新增通用联网搜索工具（web_search）
3. 保持现有前端协议和会话体验不变
4. 先做最小可用版本，再逐步增强

## 3. 范围
### 3.1 In Scope (Phase 1 / MVP)
1. 在 MCP 网关新增 `web_search` 工具（搜索 + 摘要 + 来源）
2. 主应用支持模型工具调用循环（最多 N 次调用，避免死循环）
3. 工具白名单：`get_weather`、`web_search`（后续可继续加）
4. 回答中附带来源（标题 + URL）
5. 失败回退：工具不可用时走普通 LLM 回复并提示限制

### 3.2 Out of Scope (Phase 2+)
1. 多工具并行调用与复杂规划器（Planner）
2. 深度网页抓取与长文抽取
3. 成本治理（配额中心、精细缓存策略）
4. 多模型路由（便宜模型/强模型自动切换）

## 4. 功能需求
### FR-1 通用 MCP 工具层
1. 所有外部能力通过 MCP 暴露
2. 工具定义必须有：`name`、`description`、`inputSchema`
3. 工具返回必须有：
   - `text`（可读摘要）
   - `data`（结构化字段）
   - `sources`（若有外部来源）

### FR-2 Web Search 工具
1. Tool 名称：`web_search`
2. 输入：
   - `query` (string, required)
   - `max_results` (number, optional, default 5, range 1-10)
3. 输出：
   - `query`
   - `results[]`（title/url/snippet/published_at 可选）
   - `provider`
4. 错误场景：
   - 空 query
   - 上游失败/超时
   - 结果为空

### FR-3 Tool Calling Agent（主应用）
1. 聊天入口保持 `/api/chat` 不变
2. 在 `lib/llm.ts` 中实现工具调用循环：
   - 模型先判断是否需要调用工具
   - 若需要：返回 tool call
   - 后端执行 MCP 工具并把结果回填到模型上下文
   - 模型再生成最终回答
3. 限制最大调用步数（建议 3）
4. 对工具调用过程做日志记录（不含敏感信息）

### FR-4 回答可追溯性
1. 若使用 `web_search`，最终回答附来源列表
2. 来源至少包含：标题 + URL

### FR-5 兼容性
1. 保持 SSE 事件协议不变：`delta` / `done` / `error`
2. 不破坏现有会话 CRUD 与前端展示
3. 现有 `get_weather` 工具继续可用

## 5. 非功能需求
1. 稳定性：工具失败不应导致整次会话中断
2. 性能：单次工具调用尽量 < 5s（网络波动除外）
3. 可维护性：工具实现与 Agent 编排分层
4. 可观测性：可定位每次工具调用的参数、耗时、结果数量

## 6. 技术约束
1. 统一 MCP，不允许主应用直接散落第三方 HTTP 调用
2. 搜索工具优先使用可替换 provider 封装（便于后续换服务）
3. 环境变量缺失时要给出明确报错文案

## 7. 验收标准
1. 用户问“今天 AI 领域有什么新闻？”可触发 `web_search` 并返回来源
2. 用户问“北京今天温度？”可触发 `get_weather`
3. 用户问常规问题（无需联网）不触发工具
4. `mcp-gateway` 构建通过
5. 主项目 TypeScript 检查通过

## 8. 风险与缓解
1. 模型过度调用工具：
   - 缓解：限制最大调用步数 + tool choice 提示
2. 搜索噪声高：
   - 缓解：限制结果数 + 模型二次归纳
3. 成本/延迟上升：
   - 缓解：后续加缓存与查询去重
4. 来源可信度不一：
   - 缓解：后续加域名白名单/优先级策略
